# SA VRP Решатель

Стохастический алгоритм решения задачи Vehicle Routing Problem (VRP) с использованием Simulated Annealing и многопроцессной обработки.

## Особенности

- **Simulated Annealing**: Глобальный стохастический поиск с контролируемым охлаждением
- **Многопроцессная обработка**: Полное использование 4 CPU без ограничений GIL
- **Атомарность микрополигонов**: Соблюдение ограничения на неделимость микрополигонов между курьерами
- **Мониторинг ресурсов**: Детальное отслеживание CPU и RAM
- **Таймауты**: Контроль времени выполнения для соблюдения ограничений
- **Воспроизводимость**: Фиксированные seed'ы для детерминированных результатов

## Архитектура

### Модули

1. **`prepare_data.py`** - Предобработка данных
   - Извлечение нужных расстояний из большого файла
   - Вычисление микрополигонов и порталов
   - Создание оптимизированной SQLite базы

2. **`worker.py`** - Воркеры для многопроцессной обработки
   - Оценка маршрутов курьеров
   - Thread-safe доступ к SQLite
   - Кэширование результатов

3. **`sa_solver.py`** - Основной алгоритм Simulated Annealing
   - Генерация и применение ходов
   - Параллельная оценка решений
   - Управление температурой и принятием решений

4. **`main.py`** - Главный модуль
   - Парсинг аргументов командной строки
   - Мониторинг ресурсов
   - Управление жизненным циклом

### Алгоритм

1. **Предобработка данных**:
   - Фильтрация расстояний (только нужные пары)
   - Вычисление порталов для микрополигонов
   - Создание оптимизированной базы данных

2. **Начальное решение**:
   - Жадное назначение микрополигонов курьерам
   - Учет сервисных времен и размеров маршрутов

3. **Simulated Annealing**:
   - Генерация ходов (relocate, swap)
   - Параллельная оценка кандидатов
   - Принятие/отклонение по метрополису
   - Контролируемое охлаждение

4. **Валидация ограничений**:
   - Проверка 12-часового лимита
   - Штрафы за неназначенные заказы
   - Обеспечение атомарности микрополигонов

## Установка

```bash
cd sa_vrp_solver
pip install -r requirements.txt
```

## Использование

### Базовый запуск

```bash
python main.py \
    --orders ../ml_ozon_logistic/ml_ozon_logistic_dataSetOrders.json \
    --couriers ../ml_ozon_logistic/ml_ozon_logistic_dataSetCouriers.json \
    --durations ../ml_ozon_logistic/ml_ozon_logistic_dataDurations.json \
    --output sa_solution.json \
    --time_budget 2400 \
    --max_workers 4
```

### Параметры

- `--orders`: Путь к файлу заказов
- `--couriers`: Путь к файлу курьеров  
- `--durations`: Путь к файлу расстояний
- `--output`: Файл для сохранения решения
- `--data_dir`: Директория для промежуточных данных (по умолчанию: `sa_vrp_solver/data`)
- `--max_workers`: Количество процессов (по умолчанию: 4)
- `--time_budget`: Бюджет времени в секундах (по умолчанию: 2400 = 40 минут)
- `--seed`: Seed для воспроизводимости
- `--force_prepare`: Принудительная переподготовка данных
- `--preprocessing_only`: Только подготовка данных без решения

### Только подготовка данных

```bash
python main.py \
    --orders ../ml_ozon_logistic/ml_ozon_logistic_dataSetOrders.json \
    --couriers ../ml_ozon_logistic/ml_ozon_logistic_dataSetCouriers.json \
    --durations ../ml_ozon_logistic/ml_ozon_logistic_dataDurations.json \
    --preprocessing_only
```

## Мониторинг ресурсов

Алгоритм автоматически отслеживает:
- Использование CPU (процесс и система)
- Использование RAM (текущее и пиковое)
- Время выполнения
- Количество итераций и принятых ходов

Логи сохраняются в `sa_vrp_solver.log` и выводятся в консоль.

## Формат вывода

Решение сохраняется в JSON формате:

```json
{
  "meta": {
    "iterations": 1000,
    "accepted_moves": 450,
    "infeasible_count": 0,
    "total_cost": 1234567,
    "penalty_count": 0,
    "feasible": true
  },
  "solution": {
    "routes": [
      {
        "courier_id": 1,
        "mp_sequence": [5, 12, 8],
        "route_time": 23456,
        "travel_time": 18900,
        "service_time": 4556,
        "feasible": true
      }
    ],
    "assignment": {
      "5": 1,
      "12": 1,
      "8": 1
    }
  }
}
```

## Производительность

### Ожидаемые характеристики

- **Время предобработки**: 15-30 минут (один раз)
- **Время решения**: 30-40 минут (в рамках 1-часового лимита)
- **Использование памяти**: 2-8 GB RAM
- **Использование CPU**: 100% на 4 ядрах

### Оптимизации

- **Фильтрация расстояний**: Извлечение только нужных пар
- **SQLite оптимизации**: WAL режим, увеличенный кэш
- **Многопроцессность**: Полное избежание GIL
- **Кэширование**: LRU кэш для частых вычислений

## Ограничения

- **Жесткие ограничения**: 12 часов на курьера, атомарность микрополигонов
- **Штрафы**: 3000 секунд за неназначенный заказ
- **Ресурсы**: 4 CPU, 32 GB RAM, ≤1 час времени

## Воспроизводимость

Для получения воспроизводимых результатов используйте фиксированный seed:

```bash
python main.py --seed 42 [другие параметры]
```

## Логирование

Подробные логи включают:
- Прогресс предобработки данных
- Статистику SA (температура, принятые ходы)
- Использование ресурсов
- Ошибки и предупреждения

Логи сохраняются в `sa_vrp_solver.log` для анализа производительности.
